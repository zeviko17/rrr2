<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>שליחת הודעות ווצאפ לקבוצות</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            padding: 2rem;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">שליחת הודעות ווצאפ לקבוצות</h1>
        
        <div class="mb-3">
            <button id="select-all-btn" class="btn btn-outline-primary">בחר הכל</button>
        </div>

        <ul id="group-list" class="list-unstyled mb-4">
            <!-- כאן יוצגו שמות הקבוצות -->
        </ul>

        <div class="mb-3">
            <label for="message" class="form-label">תוכן ההודעה</label>
            <textarea id="message" class="form-control" rows="5" placeholder="הקלד את תוכן ההודעה..."></textarea>
        </div>

        <div class="mb-3">
            <label for="file-upload" class="form-label">העלאת קבצים</label>
            <input type="file" id="file-upload" class="form-control" multiple>
        </div>

        <button id="send-btn" class="btn btn-primary">שלח הודעה לקבוצות שנבחרו</button>
    </div>

    <script src="config.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            console.log("JavaScript file is connected successfully!");

            let groups = {}; // משתנה לאחסון שמות קבוצות וה-IDs שלהן

            async function loadGroups() {
                const SHEET_URL = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=${CONFIG.SHEET_NAME}`;

                try {
                    const response = await fetch(SHEET_URL);
                    const text = await response.text();
                    const data = JSON.parse(text.substr(47).slice(0, -2));
                    
                    data.table.rows.forEach(row => {
                        const groupName = row.c[1]?.v;  // עמודה B - שם הקבוצה
                        const groupId = row.c[3]?.v;    // עמודה D - ID של הקבוצה
                        if (groupName && groupId) {
                            groups[groupName] = groupId;
                        }
                    });

                    console.log('Groups loaded:', Object.keys(groups).length);
                    displayGroups();
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            }

            function displayGroups() {
                const groupList = document.getElementById("group-list");
                groupList.innerHTML = '';

                Object.keys(groups).forEach(name => {
                    // יצירת תיבת סימון לכל קבוצה
                    const li = document.createElement('li');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'group-checkbox';
                    checkbox.value = name;
                    checkbox.id = `group-${groups[name]}`;

                    const label = document.createElement('label');
                    label.htmlFor = `group-${groups[name]}`;
                    label.textContent = ` ${name} (ID: ${groups[name]})`;

                    li.appendChild(checkbox);
                    li.appendChild(label);
                    groupList.appendChild(li);
                });
            }

            function toggleSelectAll(checked) {
                const checkboxes = document.querySelectorAll('.group-checkbox');
                checkboxes.forEach(checkbox => checkbox.checked = checked);
            }

            // הוספת פונקציונליות לכפתור "בחר הכל/נקה הכל"
            const selectAllBtn = document.getElementById('select-all-btn');
            selectAllBtn.addEventListener('click', function() {
                if (selectAllBtn.textContent === 'בחר הכל') {
                    toggleSelectAll(true);
                    selectAllBtn.textContent = 'נקה הכל';
                } else {
                    toggleSelectAll(false);
                    selectAllBtn.textContent = 'בחר הכל';
                }
            });

            // פונקציונליות לכפתור השליחה
            const sendBtn = document.getElementById('send-btn');
            sendBtn.addEventListener('click', async function() {
                const selectedGroups = [];
                document.querySelectorAll('.group-checkbox:checked').forEach(checkbox => {
                    selectedGroups.push(groups[checkbox.value]);
                });

                const message = document.getElementById('message').value;
                const files = document.getElementById('file-upload').files;

                if (selectedGroups.length === 0) {
                    alert('אנא בחר לפחות קבוצה אחת לשליחה.');
                    return;
                }

                if (!message) {
                    alert('אנא הקלד את תוכן ההודעה.');
                    return;
                }

                // שליחת הודעה לקבוצות שנבחרו
                for (let chatId of selectedGroups) {
                    try {
                        if (files.length > 0) {
                            // שליחה עם קובץ
                            const file = files[0]; // נשלח רק את הקובץ הראשון כרגע
                            const reader = new FileReader();
                            reader.onload = async function(e) {
                                const fileUrl = e.target.result;
                                const response = await sendMessageWithImage(chatId, message, fileUrl);
                                console.log(response);
                            };
                            reader.readAsDataURL(file);
                        } else {
                            // שליחה של טקסט בלבד
                            const response = await sendTextMessage(chatId, message);
                            console.log(response);
                        }
                    } catch (error) {
                        console.error('Error sending message to group:', chatId, error);
                    }
                }

                alert('ההודעה נשלחה לקבוצות שנבחרו (בפועל).');
            });

            // פונקציות לשליחת הודעות באמצעות Green API
            async function sendTextMessage(chatId, messageText) {
                const sendMessageUrl = CONFIG.SEND_MESSAGE_URL;

                const payload = {
                    "chatId": chatId,
                    "message": messageText
                };

                const options = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                };

                const response = await fetch(sendMessageUrl, options);
                return await response.json();
            }

            async function sendMessageWithImage(chatId, messageText, imageUrl) {
                const sendFileUrl = CONFIG.SEND_FILE_URL;

                const payload = {
                    "chatId": chatId,
                    "urlFile": imageUrl,
                    "fileName": "image.jpg",
                    "caption": messageText
                };

                const options = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                };

                const response = await fetch(sendFileUrl, options);
                return await response.json();
            }

            // טעינת הקבוצות בעת טעינת הדף
            loadGroups();
        });
    </script>
</body>
</html>
